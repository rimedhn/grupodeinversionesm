<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Grupo de Inversiones Múltiples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .nav-item.active { background: rgba(255, 255, 255, 0.2); color: white; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); }
        .table-dark { background: #1f2937; }
        .table-dark th { background: #374151; color: #f9fafb; }
        .table-dark td { color: #e5e7eb; border-color: #374151; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl shadow-2xl p-8 w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <div class="bg-white/20 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 backdrop-blur-sm">
                    <i class="fas fa-building text-white text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Grupo de Inversiones</h1>
                <h2 class="text-xl font-semibold text-white/90 mb-1">Múltiples</h2>
                <p class="text-white/70">Sistema de Gestión Financiera</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Usuario</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-white/60"></i>
                        <input type="text" id="username" required 
                               class="w-full pl-12 pr-4 py-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-white/30 focus:border-white/40 backdrop-blur-sm"
                               placeholder="Ingresa tu usuario">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Contraseña</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-white/60"></i>
                        <input type="password" id="password" required 
                               class="w-full pl-12 pr-4 py-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-white/30 focus:border-white/40 backdrop-blur-sm"
                               placeholder="Ingresa tu contraseña">
                    </div>
                </div>
                
                <button type="submit" id="loginBtn" 
                        class="w-full bg-white/20 text-white py-4 rounded-xl hover:bg-white/30 transition duration-300 font-semibold backdrop-blur-sm border border-white/30">
                    <span id="loginBtnText">Iniciar Sesión</span>
                    <i id="loginSpinner" class="fas fa-spinner loading hidden ml-2"></i>
                </button>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-4 bg-red-500/20 border border-red-400/30 text-red-100 rounded-xl text-sm backdrop-blur-sm"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen gradient-bg">
        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="glass-effect w-80 min-h-screen border-r border-white/20 sidebar-transition transform -translate-x-full lg:translate-x-0 fixed lg:relative z-30">
                <!-- Logo Section -->
                <div class="p-6 border-b border-white/20">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white/20 w-12 h-12 rounded-xl flex items-center justify-center backdrop-blur-sm">
                            <i class="fas fa-building text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-white font-bold text-lg">Grupo de Inversiones</h1>
                            <p class="text-white/70 text-sm">Múltiples</p>
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="p-6 border-b border-white/20">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="text-white font-medium" id="userDisplayName">Usuario</p>
                            <p class="text-white/70 text-sm" id="userRole">Administrador</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="p-6">
                    <div class="space-y-2">
                        <button class="nav-item w-full flex items-center px-4 py-3 text-white/80 rounded-xl transition duration-300" data-section="overview">
                            <i class="fas fa-chart-pie mr-3 text-lg"></i>
                            <span class="font-medium">Dashboard</span>
                        </button>
                        <button class="nav-item w-full flex items-center px-4 py-3 text-white/80 rounded-xl transition duration-300" data-section="capital">
                            <i class="fas fa-coins mr-3 text-lg"></i>
                            <span class="font-medium">Capital Social</span>
                        </button>
                        <button class="nav-item w-full flex items-center px-4 py-3 text-white/80 rounded-xl transition duration-300" data-section="clients">
                            <i class="fas fa-users mr-3 text-lg"></i>
                            <span class="font-medium">Clientes</span>
                        </button>
                        <button class="nav-item w-full flex items-center px-4 py-3 text-white/80 rounded-xl transition duration-300" data-section="loans">
                            <i class="fas fa-hand-holding-usd mr-3 text-lg"></i>
                            <span class="font-medium">Préstamos</span>
                        </button>
                        <button class="nav-item w-full flex items-center px-4 py-3 text-white/80 rounded-xl transition duration-300" data-section="payments">
                            <i class="fas fa-credit-card mr-3 text-lg"></i>
                            <span class="font-medium">Pagos</span>
                        </button>
                    </div>
                </nav>

                <!-- Logout Button -->
                <div class="absolute bottom-6 left-6 right-6">
                    <button id="logoutBtn" class="w-full bg-red-500/20 text-white px-4 py-3 rounded-xl hover:bg-red-500/30 transition duration-300 backdrop-blur-sm border border-red-400/30">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Mobile Header -->
                <div class="lg:hidden mb-6">
                    <button id="sidebarToggle" class="bg-white/20 text-white p-3 rounded-xl backdrop-blur-sm border border-white/30">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <!-- Overview Section -->
                <div id="overviewSection" class="section">
                    <div class="mb-8">
                        <h2 class="text-4xl font-bold text-white mb-2">Dashboard Ejecutivo</h2>
                        <p class="text-white/70 text-lg">Resumen general de operaciones</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card rounded-2xl p-6 border border-white/20 backdrop-blur-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm font-medium mb-1">Capital Total</p>
                                    <p class="text-3xl font-bold text-white" id="totalCapital">L. 0</p>
                                </div>
                                <div class="bg-blue-500/30 p-4 rounded-xl backdrop-blur-sm">
                                    <i class="fas fa-coins text-blue-200 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card rounded-2xl p-6 border border-white/20 backdrop-blur-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm font-medium mb-1">Total Clientes</p>
                                    <p class="text-3xl font-bold text-white" id="totalClients">0</p>
                                </div>
                                <div class="bg-green-500/30 p-4 rounded-xl backdrop-blur-sm">
                                    <i class="fas fa-users text-green-200 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card rounded-2xl p-6 border border-white/20 backdrop-blur-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm font-medium mb-1">Préstamos Activos</p>
                                    <p class="text-3xl font-bold text-white" id="activeLoans">0</p>
                                </div>
                                <div class="bg-yellow-500/30 p-4 rounded-xl backdrop-blur-sm">
                                    <i class="fas fa-hand-holding-usd text-yellow-200 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card rounded-2xl p-6 border border-white/20 backdrop-blur-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/70 text-sm font-medium mb-1">Pagos del Mes</p>
                                    <p class="text-3xl font-bold text-white" id="monthlyPayments">L. 0</p>
                                </div>
                                <div class="bg-purple-500/30 p-4 rounded-xl backdrop-blur-sm">
                                    <i class="fas fa-credit-card text-purple-200 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
                            <h3 class="text-xl font-bold text-white mb-6">Distribución de Capital</h3>
                            <div class="bg-white/5 rounded-xl p-4">
                                <canvas id="capitalChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                        <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
                            <h3 class="text-xl font-bold text-white mb-6">Préstamos por Estado</h3>
                            <div class="bg-white/5 rounded-xl p-4">
                                <canvas id="loansChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Capital Section -->
                <div id="capitalSection" class="section hidden">
                    <div class="mb-8">
                        <h2 class="text-4xl font-bold text-white mb-2">Capital Social</h2>
                        <p class="text-white/70 text-lg">Gestión del capital y socios</p>
                    </div>

                    <div class="glass-effect rounded-2xl border border-white/20 backdrop-blur-sm overflow-hidden">
                        <div class="px-8 py-6 border-b border-white/20">
                            <h3 class="text-xl font-bold text-white">Registro de Capital</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-dark">
                                <thead>
                                    <tr>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Socio</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Aporte</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Porcentaje</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="capitalTableBody" class="divide-y divide-white/10">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Clients Section -->
                <div id="clientsSection" class="section hidden">
                    <div class="mb-8 flex justify-between items-center">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">Clientes</h2>
                            <p class="text-white/70 text-lg">Gestión de clientes</p>
                        </div>
                        <button id="addClientBtn" class="btn-primary text-white px-6 py-3 rounded-xl hover:shadow-lg transition duration-300 backdrop-blur-sm border border-white/20">
                            <i class="fas fa-plus mr-2"></i>Nuevo Cliente
                        </button>
                    </div>

                    <div class="glass-effect rounded-2xl border border-white/20 backdrop-blur-sm overflow-hidden">
                        <div class="px-8 py-6 border-b border-white/20">
                            <h3 class="text-xl font-bold text-white">Lista de Clientes</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-dark">
                                <thead>
                                    <tr>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Código</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Nombre</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Teléfono</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Estado</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clientsTableBody" class="divide-y divide-white/10">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Loans Section -->
                <div id="loansSection" class="section hidden">
                    <div class="mb-8 flex justify-between items-center">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">Préstamos</h2>
                            <p class="text-white/70 text-lg">Gestión de préstamos</p>
                        </div>
                        <button id="addLoanBtn" class="bg-green-500/30 text-white px-6 py-3 rounded-xl hover:bg-green-500/40 transition duration-300 backdrop-blur-sm border border-green-400/30">
                            <i class="fas fa-plus mr-2"></i>Nuevo Préstamo
                        </button>
                    </div>

                    <div class="glass-effect rounded-2xl border border-white/20 backdrop-blur-sm overflow-hidden">
                        <div class="px-8 py-6 border-b border-white/20">
                            <h3 class="text-xl font-bold text-white">Lista de Préstamos</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-dark">
                                <thead>
                                    <tr>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">No. Préstamo</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Cliente</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Monto</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Plazo</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Estado</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="loansTableBody" class="divide-y divide-white/10">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="paymentsSection" class="section hidden">
                    <div class="mb-8 flex justify-between items-center">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">Pagos</h2>
                            <p class="text-white/70 text-lg">Registro de pagos</p>
                        </div>
                        <button id="addPaymentBtn" class="bg-purple-500/30 text-white px-6 py-3 rounded-xl hover:bg-purple-500/40 transition duration-300 backdrop-blur-sm border border-purple-400/30">
                            <i class="fas fa-plus mr-2"></i>Registrar Pago
                        </button>
                    </div>

                    <div class="glass-effect rounded-2xl border border-white/20 backdrop-blur-sm overflow-hidden">
                        <div class="px-8 py-6 border-b border-white/20">
                            <h3 class="text-xl font-bold text-white">Historial de Pagos</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-dark">
                                <thead>
                                    <tr>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Fecha</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Cliente</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Préstamo</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Monto</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Capital</th>
                                        <th class="px-8 py-4 text-left text-sm font-bold uppercase tracking-wider">Interés</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody" class="divide-y divide-white/10">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
            <i class="fas fa-spinner loading text-blue-600 text-2xl"></i>
            <span class="text-gray-700 font-medium">Cargando datos...</span>
        </div>
    </div>

    <!-- Modals will be added here dynamically -->

    <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbz8H_0rA-rpzvXf2zHNuKkiiGz2tkG6X3G0oj7-3gnt9nlojw51hiQtNI1dp4mAk5ElLg/exec';
        
        // Global variables
        let currentUser = null;
        let capitalData = [];
        let clientsData = [];
        let loansData = [];
        let paymentsData = [];

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showError(message, elementId = 'loginError') {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-HN', {
                style: 'currency',
                currency: 'HNL',
                minimumFractionDigits: 2
            }).format(amount || 0);
        }

        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('es-HN');
        }

        // API functions
        async function makeRequest(url, options = {}) {
            try {
                console.log('Making request to:', url, 'with options:', options);
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        ...options.headers
                    }
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                return data;
            } catch (error) {
                console.error('Request error:', error);
                throw error;
            }
        }

        async function login(username, password) {
            const formData = new URLSearchParams();
            formData.append('action', 'login');
            formData.append('username', username);
            formData.append('password', password);

            return await makeRequest(API_URL, {
                method: 'POST',
                body: formData
            });
        }

        async function fetchData(action) {
            const url = `${API_URL}?action=${action}`;
            return await makeRequest(url);
        }

        // Data loading functions
        async function loadCapitalData() {
            try {
                console.log('Loading capital data...');
                const data = await fetchData('getCapitalData');
                if (data.error) {
                    console.error('Error loading capital data:', data.error);
                    capitalData = [];
                } else {
                    capitalData = Array.isArray(data) ? data : [];
                }
                console.log('Capital data loaded:', capitalData);
                updateCapitalTable();
                updateOverviewStats();
            } catch (error) {
                console.error('Error loading capital data:', error);
                capitalData = [];
            }
        }

        async function loadClientsData() {
            try {
                console.log('Loading clients data...');
                const data = await fetchData('getClientsData');
                if (data.error) {
                    console.error('Error loading clients data:', data.error);
                    clientsData = [];
                } else {
                    clientsData = Array.isArray(data) ? data : [];
                }
                console.log('Clients data loaded:', clientsData);
                updateClientsTable();
                updateOverviewStats();
            } catch (error) {
                console.error('Error loading clients data:', error);
                clientsData = [];
            }
        }

        async function loadLoansData() {
            try {
                console.log('Loading loans data...');
                const data = await fetchData('getLoansData');
                if (data.error) {
                    console.error('Error loading loans data:', data.error);
                    loansData = [];
                } else {
                    loansData = Array.isArray(data) ? data : [];
                }
                console.log('Loans data loaded:', loansData);
                updateLoansTable();
                updateOverviewStats();
            } catch (error) {
                console.error('Error loading loans data:', error);
                loansData = [];
            }
        }

        async function loadPaymentsData() {
            try {
                console.log('Loading payments data...');
                const data = await fetchData('getPaymentsData');
                if (data.error) {
                    console.error('Error loading payments data:', data.error);
                    paymentsData = [];
                } else {
                    paymentsData = Array.isArray(data) ? data : [];
                }
                console.log('Payments data loaded:', paymentsData);
                updatePaymentsTable();
                updateOverviewStats();
            } catch (error) {
                console.error('Error loading payments data:', error);
                paymentsData = [];
            }
        }

        // UI Update functions
        function updateCapitalTable() {
            const tbody = document.getElementById('capitalTableBody');
            tbody.innerHTML = '';

            if (capitalData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-8 py-6 text-center text-white/70">No hay datos de capital disponibles</td></tr>';
                return;
            }

            capitalData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition-colors';
                row.innerHTML = `
                    <td class="px-8 py-4 whitespace-nowrap text-sm font-medium text-white">${item.Socio || item.Nombre || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${formatCurrency(item.Aporte || item.Monto)}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${(item.Porcentaje || 0)}%</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white/70">${formatDate(item.Fecha)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            if (clientsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-8 py-6 text-center text-white/70">No hay clientes registrados</td></tr>';
                return;
            }

            clientsData.forEach(client => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition-colors';
                const status = client.Estatus || client.Estado || 'Activo';
                const statusClass = status.toLowerCase() === 'activo' ? 'bg-green-500/20 text-green-300 border-green-400/30' : 'bg-red-500/20 text-red-300 border-red-400/30';
                
                row.innerHTML = `
                    <td class="px-8 py-4 whitespace-nowrap text-sm font-medium text-white">${client.Codigo || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${client.Nombre || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${client.Telefono || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border backdrop-blur-sm ${statusClass}">
                            ${status}
                        </span>
                    </td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-300 hover:text-blue-100 mr-4 transition-colors">Editar</button>
                        <button class="text-red-300 hover:text-red-100 transition-colors">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateLoansTable() {
            const tbody = document.getElementById('loansTableBody');
            tbody.innerHTML = '';

            if (loansData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-8 py-6 text-center text-white/70">No hay préstamos registrados</td></tr>';
                return;
            }

            loansData.forEach(loan => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition-colors';
                const status = loan.Estatus || loan.Estado || 'Activo';
                let statusClass = 'bg-gray-500/20 text-gray-300 border-gray-400/30';
                
                switch(status.toLowerCase()) {
                    case 'activo':
                        statusClass = 'bg-green-500/20 text-green-300 border-green-400/30';
                        break;
                    case 'pagado':
                        statusClass = 'bg-blue-500/20 text-blue-300 border-blue-400/30';
                        break;
                    case 'vencido':
                        statusClass = 'bg-red-500/20 text-red-300 border-red-400/30';
                        break;
                }
                
                row.innerHTML = `
                    <td class="px-8 py-4 whitespace-nowrap text-sm font-medium text-white">${loan.NoPrestamo || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${loan.Cliente || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${formatCurrency(loan.Monto)}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${loan.Plazo || 0} meses</td>
                    <td class="px-8 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border backdrop-blur-sm ${statusClass}">
                            ${status}
                        </span>
                    </td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-300 hover:text-blue-100 mr-4 transition-colors">Ver</button>
                        <button class="text-green-300 hover:text-green-100 transition-colors">Pagar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            if (paymentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-8 py-6 text-center text-white/70">No hay pagos registrados</td></tr>';
                return;
            }

            paymentsData.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition-colors';
                row.innerHTML = `
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${formatDate(payment.Fecha)}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${payment.Cliente || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${payment.Prestamo || 'N/A'}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm font-medium text-white">${formatCurrency(payment.Monto)}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${formatCurrency(payment.Capital)}</td>
                    <td class="px-8 py-4 whitespace-nowrap text-sm text-white">${formatCurrency(payment.Interes)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateOverviewStats() {
            // Update total capital
            const totalCapital = capitalData.reduce((sum, item) => sum + (item.Aporte || item.Monto || 0), 0);
            document.getElementById('totalCapital').textContent = formatCurrency(totalCapital);

            // Update total clients
            document.getElementById('totalClients').textContent = clientsData.length;

            // Update active loans
            const activeLoans = loansData.filter(loan => (loan.Estatus || loan.Estado || '').toLowerCase() === 'activo').length;
            document.getElementById('activeLoans').textContent = activeLoans;

            // Update monthly payments
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyPayments = paymentsData
                .filter(payment => {
                    const paymentDate = new Date(payment.Fecha);
                    return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                })
                .reduce((sum, payment) => sum + (payment.Monto || 0), 0);
            document.getElementById('monthlyPayments').textContent = formatCurrency(monthlyPayments);

            // Update charts
            updateCharts();
        }

        function updateCharts() {
            // Capital distribution chart
            const capitalCtx = document.getElementById('capitalChart').getContext('2d');
            const capitalLabels = capitalData.map(item => item.Socio || item.Nombre || 'N/A');
            const capitalValues = capitalData.map(item => item.Aporte || item.Monto || 0);

            new Chart(capitalCtx, {
                type: 'doughnut',
                data: {
                    labels: capitalLabels,
                    datasets: [{
                        data: capitalValues,
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                            '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Loans status chart
            const loansCtx = document.getElementById('loansChart').getContext('2d');
            const loanStatuses = {};
            loansData.forEach(loan => {
                const status = loan.Estatus || loan.Estado || 'Activo';
                loanStatuses[status] = (loanStatuses[status] || 0) + 1;
            });

            new Chart(loansCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(loanStatuses),
                    datasets: [{
                        label: 'Cantidad de Préstamos',
                        data: Object.values(loanStatuses),
                        backgroundColor: ['#10B981', '#3B82F6', '#EF4444', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('text-white/80');
            });

            const activeItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.classList.remove('text-white/80');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');
                const loginBtnText = document.getElementById('loginBtnText');
                const loginSpinner = document.getElementById('loginSpinner');

                // Show loading state
                loginBtn.disabled = true;
                loginBtnText.textContent = 'Iniciando sesión...';
                loginSpinner.classList.remove('hidden');

                try {
                    const result = await login(username, password);
                    
                    if (result.success) {
                        currentUser = result.user;
                        
                        // Update user display
                        document.getElementById('userDisplayName').textContent = currentUser.Nombre;
                        document.getElementById('userRole').textContent = currentUser.TipoUsuario;
                        
                        // Hide login screen and show dashboard
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        
                        // Load initial data
                        showLoading();
                        await Promise.all([
                            loadCapitalData(),
                            loadClientsData(),
                            loadLoansData(),
                            loadPaymentsData()
                        ]);
                        hideLoading();
                        
                        // Show overview section by default
                        showSection('overview');
                    } else {
                        showError(result.message || 'Error de autenticación');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showError('Error de conexión. Intenta nuevamente.');
                } finally {
                    // Reset button state
                    loginBtn.disabled = false;
                    loginBtnText.textContent = 'Iniciar Sesión';
                    loginSpinner.classList.add('hidden');
                }
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginForm').reset();
            });

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            });

            // Modal buttons (placeholder)
            document.getElementById('addClientBtn').addEventListener('click', function() {
                alert('Funcionalidad de agregar cliente próximamente');
            });

            document.getElementById('addLoanBtn').addEventListener('click', function() {
                alert('Funcionalidad de agregar préstamo próximamente');
            });

            document.getElementById('addPaymentBtn').addEventListener('click', function() {
                alert('Funcionalidad de registrar pago próximamente');
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9811c211c39e7644',t:'MTc1ODIwODEwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
