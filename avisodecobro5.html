<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AVISO DE COBRO</title>
  <link rel="icon" href="https://github.com/rimedhn/calculadora-de-prestamos/blob/main/Logo%20Demo%20Finan.png?raw=true" type="image/x-icon">
  <style>
    body { 
      font-family: Arial, sans-serif;
      background: #fff; 
      padding: 0; 
      margin: 0; 
    }
    .aviso-container { 
      width: 8.5in; 
      margin: 0 auto; 
      background: #fff; 
      min-height: 11in; 
      padding: 0.5in 0.75in; 
      position: relative; 
    }
    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #000;
    }
    .logo-section {
      flex: 0 0 auto;
    }
    .logo-img { 
      width: 100px; 
      height: 100px; 
      object-fit: contain; 
    }
    .empresa-section {
      flex: 1;
      text-align: right;
      padding-left: 20px;
    }
    .empresa { 
      font-size: 22px; 
      font-weight: bold; 
      color: #000;
      margin-bottom: 5px;
    }
    .empresa-info { 
      font-size: 12px; 
      color: #000; 
      line-height: 1.5;
    }
    .titulo-aviso {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      text-transform: uppercase;
      margin: 30px 0 25px 0;
      color: #000;
    }
    .info-section {
      margin-bottom: 25px;
      font-size: 14px;
    }
    .info-row {
      margin-bottom: 8px;
      display: flex;
    }
    .info-label {
      font-weight: bold;
      min-width: 120px;
    }
    .info-value {
      flex: 1;
    }
    .separador-linea {
      border-top: 2px solid #000;
      margin: 20px 0;
    }
    .cuerpo-aviso {
      text-align: justify;
      line-height: 1.8;
      font-size: 14px;
      margin: 25px 0;
      color: #000;
    }
    .cuerpo-aviso p {
      margin-bottom: 15px;
    }
    .valor-letras {
      font-weight: bold;
      text-decoration: underline;
    }
    .valor-numeros {
      font-weight: bold;
    }
    .cuotas-detalle {
      font-weight: bold;
      text-decoration: underline;
    }
    .dias-mora {
      font-weight: bold;
      color: #000;
      text-decoration: underline;
    }
    .firma-section {
      margin-top: 60px;
      text-align: center;
    }
    .linea-firma {
      width: 350px;
      margin: 0 auto;
      border-top: 2px solid #000;
      padding-top: 8px;
      font-size: 13px;
      font-weight: bold;
    }
    .footer-nota {
      margin-top: 30px;
      font-size: 11px;
      font-style: italic;
      text-align: center;
      color: #333;
    }
    @media print {
      body { 
        background: #fff !important; 
      }
      .aviso-container { 
        page-break-after: always; 
        box-shadow: none;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="aviso-container">
    <div class="header-section">
      <div class="logo-section">
        <img class="logo-img" src="https://github.com/rimedhn/calculadora-de-prestamos/blob/main/Logo%20Demo%20Finan.png?raw=true" alt="Logo" />
      </div>
      <div class="empresa-section">
        <div class="empresa">GRUPO DE INVERSIONES M</div>
        <div class="empresa-info">RTN. XXXXXXXXXXXXXXX</div>
        <div class="empresa-info">Dirección del negocio</div>
        <div class="empresa-info">Email: email@grupoinversiones.com</div>
        <div class="empresa-info">Tel: +504 XXXX-XXXX</div>
      </div>
    </div>

    <div class="titulo-aviso" id="tituloAviso">AVISO DE COBRO</div>

    <div class="info-section">
      <div class="info-row">
        <div class="info-label">Fecha:</div>
        <div class="info-value" id="fechaAviso"></div>
      </div>
      <div class="info-row">
        <div class="info-label">Señor(a):</div>
        <div class="info-value" id="nombreCliente"></div>
      </div>
      <div class="info-row">
        <div class="info-label">Dirección:</div>
        <div class="info-value" id="direccionCliente"></div>
      </div>
    </div>

    <div class="separador-linea"></div>

    <div class="cuerpo-aviso" id="cuerpoAviso">
      <!-- El contenido se cargará dinámicamente -->
    </div>

    <div class="firma-section">
      <div class="linea-firma">
        Atentamente
      </div>
    </div>

    <div class="footer-nota">
      Para cualquier consulta o aclaración, favor contactar a nuestras oficinas en el horario establecido.
    </div>
  </div>

  <script>
    const openSheetAviso = "https://opensheet.elk.sh/1dFCk-ZMkBoeD2LRq9ENg61J7sBz-BZg_QIX5r7oKzZc/AvisosDeCobro";
    const openSheetPrestamo = "https://opensheet.elk.sh/13bXFVitqBpkNmPTqK47USNRT2zeAeEltQiufuzKltpE/Prestamo";
    const openSheetAbono = "https://opensheet.elk.sh/13bXFVitqBpkNmPTqK47USNRT2zeAeEltQiufuzKltpE/Abono prestamo";

    function getQueryParam(param) {
      var urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function fetchJSON(url) {
      return fetch(url).then(r => r.json());
    }

    function formatCurrency(num) {
      if (isNaN(num)) return "L 0.00";
      return "L " + parseFloat(num).toLocaleString('es-HN', {minimumFractionDigths: 2, maximumFractionDigits: 2});
    }

    function parseNumber(val) {
      if (val == undefined || val == null) return 0;
      val = ("" + val).replace("L", "").replace("$", "").replace(/,/g, "").trim();
      return parseFloat(val) || 0;
    }

    // Parse dd/mm/yyyy -> Date
    function parseDateDMY(s) {
      if (!s) return null;
      s = String(s).trim();
      let parts = s.split("/");
      if (parts.length === 3) {
        let dd = parseInt(parts[0], 10);
        let mm = parseInt(parts[1], 10);
        let yyyy = parseInt(parts[2], 10);
        if (!isNaN(dd) && !isNaN(mm) && !isNaN(yyyy)) {
          return new Date(yyyy, mm - 1, dd);
        }
      }
      return null;
    }

    function formatFechaDMY(fechaStr) {
      let d = parseDateDMY(fechaStr);
      if (!d || isNaN(d.getTime())) return fechaStr || "";
      let dd = d.getDate() > 9 ? d.getDate() : "0" + d.getDate();
      let mm = (d.getMonth() + 1) > 9 ? (d.getMonth() + 1) : "0" + (d.getMonth() + 1);
      let yyyy = d.getFullYear();
      return dd + "/" + mm + "/" + yyyy;
    }

    function formatDateObjectDMY(d) {
      if (!d || isNaN(d.getTime())) return "";
      let dd = d.getDate() > 9 ? d.getDate() : "0" + d.getDate();
      let mm = (d.getMonth() + 1) > 9 ? (d.getMonth() + 1) : "0" + (d.getMonth() + 1);
      let yyyy = d.getFullYear();
      return dd + "/" + mm + "/" + yyyy;
    }

    // Convertir número a letras en español (Lempiras)
    function numeroALetras(num) {
      const unidades = ['', 'UN', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE'];
      const decenas = ['', '', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
      const especiales = ['DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECISÉIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE'];
      const centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];

      if (num === 0) return 'CERO LEMPIRAS';

      let entero = Math.floor(num);
      let decimales = Math.round((num - entero) * 100);

      function convertirGrupo(n) {
        if (n === 0) return '';
        if (n < 10) return unidades[n];
        if (n < 20) return especiales[n - 10];
        if (n < 100) {
          let dec = Math.floor(n / 10);
          let uni = n % 10;
          if (uni === 0) return decenas[dec];
          if (dec === 2) return 'VEINTI' + unidades[uni];
          return decenas[dec] + ' Y ' + unidades[uni];
        }
        let cen = Math.floor(n / 100);
        let resto = n % 100;
        if (n === 100) return 'CIEN';
        return centenas[cen] + (resto > 0 ? ' ' + convertirGrupo(resto) : '');
      }

      function convertirNumero(n) {
        if (n === 0) return 'CERO';
        if (n === 1) return 'UN';
        
        let millones = Math.floor(n / 1000000);
        let restoMillones = n % 1000000;
        let miles = Math.floor(restoMillones / 1000);
        let restoMiles = restoMillones % 1000;
        
        let texto = '';
        
        if (millones > 0) {
          if (millones === 1) {
            texto = 'UN MILLÓN';
          } else {
            texto = convertirGrupo(millones) + ' MILLONES';
          }
        }
        
        if (miles > 0) {
          if (texto) texto += ' ';
          if (miles === 1) {
            texto += 'MIL';
          } else {
            texto += convertirGrupo(miles) + ' MIL';
          }
        }
        
        if (restoMiles > 0) {
          if (texto) texto += ' ';
          texto += convertirGrupo(restoMiles);
        }
        
        return texto;
      }

      let textoEntero = convertirNumero(entero);
      let textoFinal = textoEntero + ' LEMPIRAS';
      
      if (decimales > 0) {
        textoFinal += ' CON ' + (decimales < 10 ? '0' : '') + decimales + '/100';
      }
      
      return textoFinal;
    }

    // Calcular fechas de pago vencidas manteniendo el día de la fecha de aprobación
    function calcularFechasVencidas(fechaAprobacion, ultimoPagoStr, periodo, cuotasPendientes) {
      let fechaAprob = parseDateDMY(fechaAprobacion);
      let ultimoPago = parseDateDMY(ultimoPagoStr);
      
      if (!fechaAprob || isNaN(fechaAprob.getTime())) {
        return [];
      }
      if (!ultimoPago || isNaN(ultimoPago.getTime())) {
        return [];
      }
      
      let diaOriginal = fechaAprob.getDate();
      let periodoNum = parseInt(periodo) || 30;
      let fechas = [];
      
      // Determinar tipo de periodo
      let esMensual = periodoNum === 30 || periodoNum === 31;
      
      for (let i = 1; i <= cuotasPendientes; i++) {
        let fechaVenc;
        
        if (esMensual) {
          // Para periodos mensuales, sumar meses manteniendo el día
          fechaVenc = new Date(ultimoPago);
          fechaVenc.setMonth(ultimoPago.getMonth() + i);
          
          // Manejar caso especial de febrero y meses con menos días
          let mesDestino = fechaVenc.getMonth();
          let añoDestino = fechaVenc.getFullYear();
          let ultimoDiaMes = new Date(añoDestino, mesDestino + 1, 0).getDate();
          
          if (diaOriginal > ultimoDiaMes) {
            fechaVenc.setDate(ultimoDiaMes);
          } else {
            fechaVenc.setDate(diaOriginal);
          }
        } else {
          // Para otros periodos (diario, semanal, quincenal), sumar días
          fechaVenc = new Date(ultimoPago);
          fechaVenc.setDate(ultimoPago.getDate() + (periodoNum * i));
        }
        
        fechas.push(formatDateObjectDMY(fechaVenc));
      }
      
      return fechas;
    }

    // Calcular días en mora desde la primera cuota vencida
    function calcularDiasMora(fechaAprobacion, ultimoPagoStr, periodo) {
      let fechaAprob = parseDateDMY(fechaAprobacion);
      let ultimoPago = parseDateDMY(ultimoPagoStr);
      
      if (!fechaAprob || isNaN(fechaAprob.getTime())) return 0;
      if (!ultimoPago || isNaN(ultimoPago.getTime())) return 0;
      
      let diaOriginal = fechaAprob.getDate();
      let periodoNum = parseInt(periodo) || 30;
      let esMensual = periodoNum === 30 || periodoNum === 31;
      
      let primeraVencida;
      
      if (esMensual) {
        primeraVencida = new Date(ultimoPago);
        primeraVencida.setMonth(ultimoPago.getMonth() + 1);
        
        let mesDestino = primeraVencida.getMonth();
        let añoDestino = primeraVencida.getFullYear();
        let ultimoDiaMes = new Date(añoDestino, mesDestino + 1, 0).getDate();
        
        if (diaOriginal > ultimoDiaMes) {
          primeraVencida.setDate(ultimoDiaMes);
        } else {
          primeraVencida.setDate(diaOriginal);
        }
      } else {
        primeraVencida = new Date(ultimoPago);
        primeraVencida.setDate(ultimoPago.getDate() + periodoNum);
      }
      
      let hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      
      if (primeraVencida >= hoy) return 0;
      
      let diffTime = hoy - primeraVencida;
      let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }

    // Función auxiliar para obtener valor con fallback
    function obtenerValor(aviso, campo, valorPorDefecto = "") {
      // Si el campo existe en aviso y tiene valor, usarlo
      if (aviso[campo] !== undefined && aviso[campo] !== null && String(aviso[campo]).trim() !== "") {
        return aviso[campo];
      }
      // Si no, retornar el valor por defecto
      return valorPorDefecto;
    }

    async function loadAvisoCobro() {
      let idaviso = getQueryParam('idaviso');
      if (!idaviso) {
        alert("Falta el parámetro idaviso.");
        return;
      }

      let [avisos, prestamos, abonos] = await Promise.all([
        fetchJSON(openSheetAviso),
        fetchJSON(openSheetPrestamo),
        fetchJSON(openSheetAbono)
      ]);

      let aviso = avisos.find(a => String(a.idAviso) === String(idaviso));
      
      if (!aviso) {
        alert("Aviso no encontrado.");
        return;
      }

      // Buscar datos del préstamo
      let prestamo = prestamos.find(p => String(p.idprestamo) === String(aviso.Prestamo));
      
      // Obtener datos con prioridad de AvisosDeCobro, fallback a Prestamo
      let nombreCliente = obtenerValor(aviso, "NombreCliente", prestamo ? prestamo.NombreCliente : "");
      let direccion = obtenerValor(aviso, "Direccion", "");
      let fechaAprobacion = obtenerValor(aviso, "FechaAprobado", prestamo ? prestamo.FechaAprobado : "");
      let monto = obtenerValor(aviso, "Monto", "0");
      let cuotas = obtenerValor(aviso, "Cuotas", "0");
      let ultimoPago = obtenerValor(aviso, "UltimoPago", "");
      let periodo = obtenerValor(aviso, "Periodo", prestamo ? (prestamo["Periodo Pago en dias"] || "30") : "30");

      // Datos básicos del aviso
      document.getElementById("tituloAviso").textContent = aviso.Aviso || "AVISO DE COBRO";
      document.getElementById("fechaAviso").textContent = formatFechaDMY(aviso.Fecha);
      document.getElementById("nombreCliente").textContent = nombreCliente;
      document.getElementById("direccionCliente").textContent = direccion;

      // Calcular valores
      let montoPendiente = parseNumber(monto);
      let cuotasPendientes = parseInt(cuotas) || 0;

      // Calcular fechas vencidas y días en mora usando fecha de aprobación
      let fechasVencidas = calcularFechasVencidas(fechaAprobacion, ultimoPago, periodo, cuotasPendientes);
      let diasMora = calcularDiasMora(fechaAprobacion, ultimoPago, periodo);

      // Preparar reemplazos
      let valorLetras = numeroALetras(montoPendiente);
      let valorNumeros = formatCurrency(montoPendiente);
      let fechasTexto = fechasVencidas.join(", ");
      let diasTexto = diasMora.toString();

      // Procesar el texto del aviso
      let textoAviso = aviso.TextoAviso || "";

      // Reemplazar placeholders
      textoAviso = textoAviso.replace(/valor_pendiente/g, 
        '<span class="valor-letras">' + valorLetras + '</span> <span class="valor-numeros">(' + valorNumeros + ')</span>');
      
      textoAviso = textoAviso.replace(/cuotas_pendientes/g, 
        '<span class="cuotas-detalle">' + fechasTexto + '</span>');
      
      textoAviso = textoAviso.replace(/dias_pendientes/g, 
        '<span class="dias-mora">' + diasTexto + '</span>');

      // Convertir saltos de línea a párrafos
      textoAviso = '<p>' + textoAviso.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';

      // Insertar el texto procesado
      document.getElementById("cuerpoAviso").innerHTML = textoAviso;

      // Auto print after render
      setTimeout(function() {
        window.print();
      }, 800);
    }

    window.onload = loadAvisoCobro;
  </script>
</body>
</html>
